<!--registered-events.html-->
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>My Registered Events ‚Äî Plan My Event</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="css/styles.css">
  <style>
    /* Ticket-specific styles (uses your CSS variables) */
    .tickets-wrap { padding: 36px 0; }
    .tickets-grid {
      display:grid;
      grid-template-columns: repeat(2,1fr);
      gap:18px;
    }

    @media (max-width: 880px){
      .tickets-grid { grid-template-columns: 1fr; }
    }

    .ticket {
      display:flex;
      gap:0;
      background: linear-gradient(90deg, rgba(255,255,255,0.98), rgba(255,255,255,0.95));
      border-radius: 14px;
      overflow: hidden;
      box-shadow: 0 12px 28px rgba(15,23,42,0.06);
      border: 1px solid rgba(15,23,42,0.04);
      align-items: stretch;
    }

    /* left portion ‚Äî event summary */
    .ticket-left {
      flex: 1 1 65%;
      padding:18px 20px;
      background: linear-gradient(180deg, rgba(136,196,152,0.06), rgba(47,133,90,0.02));
      position: relative;
    }
    .ticket-right {
      width: 210px;
      padding: 18px;
      background: linear-gradient(180deg, var(--accent), var(--accent-2));
      color: white;
      display:flex;
      flex-direction:column;
      justify-content:space-between;
      min-width: 180px;
    }

    .event-title-ticket { font-size:20px; font-weight:700; margin:0 0 6px; color: #0f172a; }
    .event-meta-ticket { font-size:13px; color:var(--muted); margin-bottom:10px; }
    .event-desc { font-size:14px; color:#213547; margin-top:8px; line-height:1.35; }

    /* dashed separator */
    .ticket::before {
      content: "";
      width: 12px;
      background: linear-gradient(180deg, transparent 40%, rgba(0,0,0,0.06) 40%);
      position: absolute;
      top: 0;
      bottom: 0;
      left: calc(65% - 6px);
      transform: translateX(-1px);
      pointer-events: none;
    }

    .badge {
      display:inline-block;
      padding:6px 10px;
      border-radius:10px;
      background: rgba(47,133,90,0.12);
      color:var(--accent);
      font-weight:600;
      font-size:13px;
    }

    .ticket-info-row { display:flex; justify-content:space-between; gap:12px; align-items:center; margin-top:10px; flex-wrap:wrap; }
    .muted-sm { font-size:13px; color:var(--muted); }

    .small-meta { font-size:13px; color:rgba(255,255,255,0.95); }

    .btn-plain {
      background: transparent;
      color: white;
      border: 1px solid rgba(255,255,255,0.18);
      padding:8px 10px;
      border-radius:10px;
      font-weight:600;
      cursor:pointer;
    }

    .btn-unreg {
      display:inline-block;
      padding:8px 12px;
      border-radius:10px;
      text-decoration:none;
      border:none;
      cursor:pointer;
      font-weight:600;
      background:#fff;
      color:var(--accent);
    }

    .empty-state {
      text-align:center;
      padding:36px;
      background:var(--card);
      border-radius:12px;
      box-shadow: 0 8px 20px rgba(12,18,30,0.04);
    }
  </style>
</head>
<body>
  <!-- Header (keeps same look as other pages) -->
  <header class="container">
    <div style="display:flex;justify-content:space-between;align-items:center;">
      <div class="site-brand" style="display:flex;align-items:center;gap:10px;">
        <img src="images/logo.jpg" alt="Plan My Event Logo" style="height:50px;width:auto;">
        <div style="font-size:20px;font-weight:600;color:#2f855a;">Plan My Event</div>
      </div>
      <nav class="site-nav">
        <a href="index.html">Home</a>
        <a href="events.html">Upcoming Events</a>
        <a href="registered-events.html">My Registered Events</a>
        <a href="logout.html">Logout</a>
      </nav>
    </div>
  </header>

  <main class="container tickets-wrap">
    <h2 style="margin: 18px 0 6px; color:var(--accent);">My Registered Events</h2>
    <p class="muted-sm">Only you can see these. Tickets below are digital passes for events you registered for.</p>

    <div id="tickets" class="tickets-grid" style="margin-top:18px;"></div>

    <div id="empty" class="empty-state" style="display:none; margin-top:18px;">
      <h3 style="margin:0 0 8px; color:#213547;">No registered events yet</h3>
      <p style="margin:0 0 12px;">Browse upcoming events and register to see them here.</p>
      <a class="btn btn-primary" href="events.html">View Upcoming Events</a>
    </div>
  </main>
  <!-- Footer -->
 <footer class="container">
   <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;">
    
   </div>
   <footer>
   <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(221px,1fr));gap:70px;max-width:1224px;margin:0 auto;">


     <!-- Contact Info -->
     <div>
       <h4>üìç Contact Us</h4>
       <p style="color:#555;line-height:1.6;">
         <strong>Plan My Event</strong><br>
         planmyevent@gmail.com<br>
       </p>
     </div>


     <!-- Our Company -->
     <div>
       <h4>üè¢ Our Company</h4>
       <ul>
         <li><a href="about.html">About Us</a></li>
       </ul>
     </div>


     <!-- Resources -->
     <div>
       <h4>üìö Resources</h4>
       <ul>
         <li><a href="events.html">Live Events</a></li>
       </ul>
     </div>


     <!-- Call to Action -->
     <div>
       <h4>üì£ Let's Connect</h4>
       <p style="color:#555;">Ready to plan your next sustainable event?</p>
       <a href="contact.html" style="display:inline-block;margin-top:10px;padding:10px 20px;background:#2f855a;color:white;border-radius:8px;text-decoration:none;font-weight:600;">Contact Us Today!</a>
     </div>
   </div>


   <!-- Bottom Bar -->
   <div style="margin-top:40px;text-align:center;font-size:0.9rem;color:#777;">
     <p>¬© <strong>Plan My Event</strong> ‚Äî All Rights Reserved</p>
     <p><a href="privacy.html">Privacy Policy</a> | <a href="terms.html">Terms of Service</a></p>
     <p>Follow us: Facebook | Twitter | LinkedIn | Instagram</p>
   </div>
 </footer>

  <script>
    async function fetchRegistrations() {
      try {
        const res = await fetch('/api/my-registrations');
        if (res.status === 401) {
          // not logged in
          document.getElementById('tickets').innerHTML = '<div class="empty-state"><p>Please <a href="login.html">log in</a> to see your registered events.</p></div>';
          return;
        }
        const data = await res.json();
        renderTickets(data);
      } catch (err) {
        console.error('Failed to fetch registrations', err);
        document.getElementById('tickets').innerHTML = '<div class="empty-state"><p>Could not load registrations. Try again later.</p></div>';
      }
    }

    function renderTickets(items) {
      const wrap = document.getElementById('tickets');
      const empty = document.getElementById('empty');

      if (!items || items.length === 0) {
        wrap.style.display = 'none';
        empty.style.display = 'block';
        return;
      }
      wrap.style.display = 'grid';
      empty.style.display = 'none';

      wrap.innerHTML = '';
      items.forEach(item => {
        const r = item.registration || {};
        const ev = item.event || {};

        const ticket = document.createElement('div');
        ticket.className = 'ticket';

        ticket.innerHTML = `
          <div class="ticket-left">
            <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:12px;">
              <div>
                <div class="event-title-ticket">${escapeHtml(ev.eventName || r.eventName || 'Event')}</div>
                <div class="event-meta-ticket">${escapeHtml(ev.venue || '‚Äî')}</div>
                <div><span class="badge">${ev.date || 'Date TBA'}</span></div>
              </div>
              <div style="text-align:right">
                <div class="muted-sm">Registered on</div>
                <div style="font-weight:700">${new Date(r.createdAt || Date.now()).toLocaleString()}</div>
              </div>
            </div>

            <div class="ticket-info-row">
              <div>
                <div class="muted-sm">Time</div>
                <div style="font-weight:700">${ev.time || '‚Äî'}</div>
              </div>
              <div>
                <div class="muted-sm">College</div>
                <div style="font-weight:700">${escapeHtml(r.college || '‚Äî')}</div>
              </div>
              <div>
                <div class="muted-sm">Year</div>
                <div style="font-weight:700">${escapeHtml(r.year || '‚Äî')}</div>
              </div>
            </div>

            <p class="event-desc">${escapeHtml(ev.description || 'No additional event description provided.')}</p>

            <div style="margin-top:10px;">
              <button class="btn-unreg" data-reg-id="${r._id}">Unregister</button>
              <a class="btn" style="margin-left:8px;background:transparent;border:1px solid rgba(47,133,90,0.08);color:var(--accent);text-decoration:none;padding:8px 10px;border-radius:10px;font-weight:600;"
                 href="events.html">Browse more</a>
            </div>
          </div>

          <div class="ticket-right">
            <div style="font-size:13px;font-weight:700;">${escapeHtml(ev.eventName || r.eventName || '')}</div>
            <div style="margin-top:6px">
              <div style="font-size:13px;opacity:0.95">Venue</div>
              <div style="font-weight:700">${escapeHtml(ev.venue || '‚Äî')}</div>
            </div>

            <div style="margin-top:12px">
              <div style="font-size:12px;opacity:0.9">Status</div>
              <div style="font-weight:700">${ev.approved ? 'Approved' : (ev.rejected ? 'Rejected' : 'Pending')}</div>
            </div>

            <div style="text-align:center;margin-top:10px;">
              <!-- simple QR-like placeholder -->
              <div style="width:88px;height:88px;margin:0 auto;border-radius:8px;background:rgba(255,255,255,0.12);display:grid;place-items:center;font-weight:700;">
                ${(ev.eventName||'').split(' ').slice(0,2).map(s=>s[0]||'').join('').toUpperCase()}
              </div>
              <div style="font-size:12px;margin-top:8px;opacity:0.95;">Show this at entry</div>
            </div>
          </div>
        `;

        wrap.appendChild(ticket);
      });

      // attach unregister handlers
      document.querySelectorAll('.btn-unreg').forEach(btn => {
        btn.addEventListener('click', async (e) => {
          const id = btn.getAttribute('data-reg-id');
          if (!confirm('Are you sure you want to unregister from this event?')) return;
          try {
            const r = await fetch('/api/unregister/' + id, { method: 'POST' });
            if (r.ok) {
              btn.textContent = 'Cancelled';
              btn.disabled = true;
              // remove the ticket visually
              btn.closest('.ticket').remove();
              if (document.getElementById('tickets').children.length === 0) {
                document.getElementById('tickets').style.display = 'none';
                document.getElementById('empty').style.display = 'block';
              }
            } else if (r.status === 401) {
              alert('Please log in to perform this action.');
            } else {
              const json = await r.json().catch(()=>({}));
              alert(json.message || 'Could not unregister. Try again later.');
            }
          } catch (err) {
            console.error('unregister failed', err);
            alert('Network error. Try again later.');
          }
        });
      });
    }

    // tiny helper to avoid XSS
    function escapeHtml(s) {
      if (!s && s !== 0) return '';
      return String(s)
        .replaceAll('&', '&amp;')
        .replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;')
        .replaceAll('"', '&quot;')
        .replaceAll("'", '&#39;');
    }

    // load on start
    fetchRegistrations();
  </script>
</body>
</html>
